# UI内キャッシュ更新機能 使用ガイド

## 概要

配当貴族スクリーニングページに、UI内でキャッシュを更新できる機能を追加しました。
これにより、コマンドラインスクリプトを実行しなくても、ブラウザ上で簡単にキャッシュを更新できます。

## 機能の場所

1. Streamlitアプリを起動
2. 「👑 配当貴族・配当成長株スクリーニング」ページを開く
3. **⚙️ カスタマイズ設定**セクションを展開
4. **💾 キャッシュ管理**セクションに機能があります

## 画面構成

```
┌─────────────────────────────────────────────┐
│ 💾 キャッシュ管理                          │
├─────────────────────────────────────────────┤
│                                             │
│  キャッシュ済み銘柄    最終更新             │
│  ┌──────────┐    ┌──────────────┐         │
│  │ 5 銘柄   │    │ 2025-11-23   │         │
│  │          │    │ 15:03        │         │
│  └──────────┘    └──────────────┘         │
│                                             │
│  更新銘柄数        🔄 キャッシュを更新      │
│  ┌──────────┐    ┌──────────────┐         │
│  │ 50       │    │   ボタン     │         │
│  └──────────┘    └──────────────┘         │
│                                             │
└─────────────────────────────────────────────┘
```

## 使用方法

### ステップ1: 現在のキャッシュ状況を確認

- **キャッシュ済み銘柄**: 現在DBに保存されている銘柄数
- **最終更新**: 最後にキャッシュが更新された日時

例:
```
キャッシュ済み銘柄: 5 銘柄
最終更新: 2025-11-23 15:03
```

### ステップ2: 更新銘柄数を指定

「更新銘柄数」の数値入力欄で、一度に更新する銘柄数を指定します。

**推奨設定:**
- **テスト**: 5～10銘柄（約30秒～1分）
- **通常**: 50～100銘柄（約2～4分）
- **大量**: 500～1000銘柄（約20～40分）

**注意:**
- 銘柄数が多いほど時間がかかります
- yfinance APIの制限を考慮し、一度に1000銘柄以下を推奨
- 更新中はブラウザを閉じないでください

### ステップ3: 更新を実行

**🔄 キャッシュを更新**ボタンをクリックすると、更新が開始されます。

更新中の表示:
```
🔄 50 銘柄のキャッシュを更新中...

[進捗バー] ████████████░░░░░░░░ 60%

[15/50] 1301.T を処理中...
```

### ステップ4: 完了確認

更新が完了すると、サマリーが表示されます:

```
✅ キャッシュ更新完了

- 成功: 48 銘柄
- エラー: 2 銘柄
- 所要時間: 123.5秒
- 平均処理時間: 2.47秒/銘柄
```

## トラブルシューティング

### 更新が途中で止まる

**原因:** yfinance APIのレート制限またはネットワークエラー

**対処法:**
1. ブラウザをリフレッシュ
2. 数分待ってから再試行
3. 更新銘柄数を減らす（例: 100 → 50）

### エラーが多発する

**原因:** 銘柄コードが無効、またはデータが取得できない

**対処法:**
- エラーは自動的にDBに記録されます（data_quality='incomplete'）
- 問題のある銘柄は自動的にスキップされます
- 次回更新時に再試行されます

### キャッシュが古い

**原因:** 最終更新から時間が経過している

**対処法:**
1. 「更新銘柄数」を全銘柄数（例: 1616）に設定
2. 時間のある時（夜間など）に実行
3. または、定期的に100銘柄ずつ更新

## パフォーマンス

### 処理速度

- **1銘柄**: 約2～3秒
- **50銘柄**: 約2～4分
- **100銘柄**: 約4～8分
- **500銘柄**: 約20～40分
- **1616銘柄（全件）**: 約60～120分

### API制限対策

スクリプトには以下の対策が組み込まれています:
- 各銘柄の取得後、0.5秒待機
- エラーハンドリングで自動スキップ
- 不完全なデータもDBに保存（次回再試行可能）

## コマンドラインとの比較

### UI内更新（このガイド）

**メリット:**
- ブラウザ上で完結
- プログレスバーで進捗確認
- 簡単で直感的

**デメリット:**
- ブラウザを開いたままにする必要あり
- 大量更新時は時間がかかる

### コマンドライン更新

**メリット:**
- バックグラウンドで実行可能
- cronで自動化可能
- ブラウザ不要

**デメリット:**
- コマンド実行の知識が必要
- 進捗がターミナルに表示される

**コマンド例:**
```bash
# 50銘柄を更新
python scripts/update_dividend_aristocrats_cache.py --limit 50

# 全銘柄を更新
python scripts/update_dividend_aristocrats_cache.py
```

## 推奨運用

### 初回セットアップ

1. **UI内で50銘柄を更新**（テスト）
2. 結果を確認
3. 問題なければ**500銘柄を更新**
4. 最終的に**全銘柄を更新**（夜間推奨）

### 定期更新

**パターン1: UI内で手動更新**
- 週1回、100銘柄を更新
- 月1回、全銘柄を更新

**パターン2: コマンドラインで自動化**
```bash
# 週次更新（毎週日曜日の深夜2時）
0 2 * * 0 cd /path/to/gupiao_app && python scripts/update_dividend_aristocrats_cache.py
```

**パターン3: ハイブリッド**
- 平日: UI内で10～50銘柄を手動更新
- 週末: コマンドラインで全銘柄を自動更新

## まとめ

UI内キャッシュ更新機能により、以下が実現できました:

✅ ブラウザ上で簡単にキャッシュ更新
✅ プログレスバーで進捗確認
✅ リアルタイムステータス表示
✅ 更新銘柄数の柔軟な指定
✅ コマンドライン不要

これにより、技術的な知識がなくても、配当貴族スクリーニングのキャッシュを効率的に管理できます。
