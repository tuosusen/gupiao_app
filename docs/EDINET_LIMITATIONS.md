# EDINET API 制限事項と今後の課題

## 判明した問題

### 1. CSV形式（type=5）の制限

**問題:**
EDINET APIの書類取得で `type=5`（CSV形式）を指定しても、多くの書類種類でCSVデータが含まれていません。

**検証結果（トヨタ自動車 7203）:**
過去180日間で24件の書類が見つかりましたが、すべてCSV抽出に失敗：

| 書類種類 | 種類名 | ダウンロード | CSV抽出 |
|---------|--------|-------------|---------|
| '120' | 有価証券報告書 | ✓ (206KB) | ✗ |
| '135' | 訂正有価証券報告書（特例） | ✓ (142B) | ✗ |
| '140' | 四半期報告書 | - | - |
| '180' | 臨時報告書（特定事項） | ✓ (3-4KB) | ✗ |
| '220' | 内部統制報告書 | ✓ (3KB) | ✗ |
| '235' | 訂正内部統制報告書（特例） | ✓ (3KB) | ✗ |
| '350' | 臨時報告書 | ✓ (4-6KB) | ✗ |
| '090' | 発行登録通知書 | ✓ (142B) | ✗ |
| '100' | 有価証券通知書 | ✓ (15KB) | ✗ |

**ログ例:**
```
→ 書類ダウンロード試行: S100VWVY | 種類: 120
  ✓ ダウンロード成功 (206425 bytes)
  ✗ CSV抽出失敗: ZIPにCSVファイルなし
```

### 2. EDINET APIの仕様

EDINET APIには複数のデータ形式があります：

- **type=1**: 提出本文書及び監査報告書（**XBRL含む**）← 財務データはこちらに含まれる
- **type=2**: PDF形式
- **type=3**: 代替書面・添付文書
- **type=4**: 英文ファイル
- **type=5**: CSV形式 ← 現在使用中だが、多くの書類で空

**CSV形式の対応状況:**
- 一部の書類のみCSV形式に対応
- 有価証券報告書('120')などの主要書類はCSV形式に対応していない可能性が高い
- 財務データを取得するには **XBRLデータを解析する必要がある**

## 解決策

### 短期対応（提案）

1. **XBRL解析ライブラリの導入**
   - `arelle`（XBRL処理の標準ライブラリ）
   - `python-edinet`（EDINETデータ処理用）

2. **実装手順**
   ```python
   # type=1でXBRLデータを取得
   doc_content = self.get_document(doc_id, doc_type=1)

   # XBRLデータからDataFrameを抽出
   financial_data = self.extract_xbrl_data(doc_content)
   ```

3. **対象書類の絞り込み**
   - デフォルトで `['120', '140']`（有価証券報告書、四半期報告書）のみ検索
   - これらの書類にのみ詳細な財務データが含まれる

### 中期対応

1. **キャッシュ機能の実装**
   - 一度取得したデータをデータベースに保存
   - API呼び出し回数を削減

2. **バッチ処理の実装**
   - 夜間に複数企業のデータを一括取得
   - ユーザーはキャッシュされたデータを参照

### 長期対応

1. **独自のEDINETデータベース構築**
   - 定期的にEDINET APIから全書類を取得
   - 財務データを独自のデータベースに格納
   - ユーザーはデータベースから高速に取得

## 現在の実装状況

✅ 完了:
- EDINET API接続
- 書類検索機能（毎日チェック、最大180日）
- 企業コードマッチング
- 書類種類フィルタリング
- デバッグ情報出力
- **XBRLデータ解析機能（NEW!）**
  - type=1（XBRL形式）での書類取得
  - XBRLファイルのZIPからの抽出
  - XMLパース機能
  - 財務指標の自動抽出（売上高、営業利益、当期純利益、総資産、純資産、営業CF）
  - DataFrameへの変換（損益計算書、貸借対照表、キャッシュフロー計算書）

❌ 未完了:
- キャッシュ機能
- より高度なXBRL解析（全勘定科目の自動抽出）
- 時系列データの整理機能

✅ 解決済み:
- ~~CSV形式（type=5）では財務データを取得できない~~ → XBRL形式（type=1）で解決
- ~~現状では実用的な財務データ取得は不可能~~ → XBRL解析実装により解決

## 参考資料

- EDINET API仕様書: https://disclosure2.edinet-fsa.go.jp/WZEK0040.aspx
- XBRL仕様: https://www.xbrl.org/
- `arelle`: https://arelle.org/
- `python-edinet`: https://github.com/drillan/python-edinet

## 次のステップ

1. XBRL解析ライブラリ（`arelle`）のインストールと検証
2. XBRLデータから財務諸表を抽出するコードの実装
3. 取得した財務データをDataFrameに変換
4. 既存の財務指標計算ロジックとの統合
